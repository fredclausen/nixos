---
- name: Update NixOS Systems
  connection: ansible.netcommon.network_cli
  hosts: nixos
  gather_facts: false
  tags: [nixos]
  vars:
    git_branch: "{{ input_git_branch | default('main') }}"

  tasks:
    - name: Update nixos source (git pull)
      become: no
      git:
        repo: https://github.com/fredclausen/nixos.git
        dest: /home/fred/GitHub/nixos
        version: "{{ git_branch }}"
        update: yes
        clone: no
        force: no
      register: git_result

    - name: Rebuild system if repo changed
      become: yes
      command: nixos-rebuild switch --flake .#{{ hostvars[inventory_hostname]['vars']['nix_name'] }}
      args:
        chdir: /home/fred/GitHub/nixos
      when: git_result.changed

    - name: Check for reboot (NixOS, via nixos-needsreboot)
      become: yes
      command: nixos-needsreboot
      register: reboot_check
      failed_when: reboot_check.rc not in [0, 2]
      changed_when: reboot_check.rc == 2

    - name: Check if reboot-required exists
      stat:
        path: /run/reboot-required
      register: nixos_reboot

    - name: Read reboot-required details
      when: nixos_reboot.stat.exists
      slurp:
        src: /run/reboot-required
      register: reboot_details

    - name: Display reboot message
      when: nixos_reboot.stat.exists
      debug:
        msg: |
          ðŸ”´ System needs reboot
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          Raw file:
          {{ reboot_details.content | b64decode }}

          Pretty:
          {{ reboot_pretty.stdout | default('NO STDOUT') }}

          Pretty (lines):
          {{ reboot_pretty.stdout_lines | join('\n') | default('NO STDOUT_LINES') }}

- name: Update Ubuntu Systems
  connection: ansible.netcommon.network_cli
  gather_facts: false
  hosts: ubuntu
  tags: [ubuntu]

  tasks:
    - name: Update apt cache
      become: yes
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      become: yes
      apt:
        upgrade: dist

    - name: Check if reboot is needed
      stat:
        path: /var/run/reboot-required
      register: reboot_needed

    - name: Display reboot message
      debug:
        msg: "System needs reboot"
      when: reboot_needed.stat.exists
