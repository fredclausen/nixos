name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  find-systems:
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.out.outputs.servers }}
      desktops: ${{ steps.out.outputs.desktops }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Enable Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - id: out
        run: |
          echo "Evaluating nixosConfigurationsâ€¦"

          # List all hostnames from the flake
          all_systems=$(nix eval --json .#nixosConfigurations --apply builtins.attrNames)

          echo "All systems: $all_systems"

          # Define which systems are desktops
          desktop_names=("Daytona" "maranello")

          servers=()
          desktops=()

          for sys in $(jq -r '.[]' <<< "$all_systems"); do
            if [[ " ${desktop_names[*]} " =~ " $sys " ]]; then
              desktops+=("$sys")
            else
              servers+=("$sys")
            fi
          done

          echo "Servers: ${servers[*]}"
          echo "Desktops: ${desktops[*]}"

          servers_json=$(printf '%s\n' "${servers[@]}" | jq -R . | jq -s .)
          desktops_json=$(printf '%s\n' "${desktops[@]}" | jq -R . | jq -s .)

          echo "servers=$servers_json" >> "$GITHUB_OUTPUT"
          echo "desktops=$desktops_json" >> "$GITHUB_OUTPUT"

  build-servers:
    runs-on: ubuntu-latest
    needs: find-systems
    strategy:
      fail-fast: false
      matrix:
        system: ${{ fromJson(needs.find-systems.outputs.servers) }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Enable Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Build server system
        run: |
          echo "Building system: ${{ matrix.system }}"

          nix build \
            ".#nixosConfigurations.${{ matrix.system }}.config.system.build.toplevel"

  eval-desktops:
    runs-on: ubuntu-latest
    needs: find-systems
    strategy:
      fail-fast: false
      matrix:
        system: ${{ fromJson(needs.find-systems.outputs.desktops) }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Enable Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Evaluate desktop system (no build)
        run: |
          echo "Evaluating desktop config: ${{ matrix.system }}"

          nix eval ".#nixosConfigurations.${{ matrix.system }}"
