---
name: CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  discover:
    name: Discover configurations
    runs-on: ubuntu-latest
    outputs:
      systems: ${{ steps.find.outputs.systems }}
      hm_users: ${{ steps.find.outputs.hm_users }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21
        with:
          extra-conf: |
            accept-flake-config = true
            experimental-features = nix-command flakes

      - id: find
        run: |
          set -euo pipefail

          echo "Finding NixOS systems..."
          systems=$(nix eval --json .#nixosConfigurations | jq -c 'keys')
          echo "systems=$systems" >> "$GITHUB_OUTPUT"

          echo "Finding Home Manager users..."
          # Support both homeConfigurations and hmConfigurations
          if nix eval --json .#homeConfigurations >/dev/null 2>&1; then
            hm_users=$(nix eval --json .#homeConfigurations | jq -c 'keys')
          elif nix eval --json .#hmConfigurations >/dev/null 2>&1; then
            hm_users=$(nix eval --json .#hmConfigurations | jq -c 'keys')
          else
            hm_users="[]"
          fi
          echo "hm_users=$hm_users" >> "$GITHUB_OUTPUT"

  build-systems:
    name: Build system • ${{ matrix.system }}
    runs-on: ubuntu-latest
    needs: discover
    strategy:
      fail-fast: false
      matrix:
        system: ${{ fromJson(needs.discover.outputs.systems) }}

    steps:
      - uses: actions/checkout@v4
        with: { persist-credentials: false }

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21
        with:
          extra-conf: |
            accept-flake-config = true
            experimental-features = nix-command flakes

      - uses: DeterminateSystems/magic-nix-cache-action@v4

      - run: |
          echo "Building system: ${{ matrix.system }}"
          nix build ".#nixosConfigurations.${{ matrix.system }}.config.system.build.toplevel"

  build-hm:
    name: Build HM • ${{ matrix.user }}
    runs-on: ubuntu-latest
    needs: discover
    if: ${{ needs.discover.outputs.hm_users != '[]' }} # Skip if none
    strategy:
      fail-fast: false
      matrix:
        user: ${{ fromJson(needs.discover.outputs.hm_users) }}

    steps:
      - uses: actions/checkout@v4
        with: { persist-credentials: false }

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21
        with:
          extra-conf: |
            accept-flake-config = true
            experimental-features = nix-command flakes

      - uses: DeterminateSystems/magic-nix-cache-action@v4

      - run: |
          echo "Building Home Manager config for: ${{ matrix.user }}"

          # Support both homeConfigurations and hmConfigurations dynamically
          if nix eval --json .#homeConfigurations.${{ matrix.user }} >/dev/null 2>&1; then
            nix build ".#homeConfigurations.${{ matrix.user }}.activationPackage"
          else
            nix build ".#hmConfigurations.${{ matrix.user }}.activationPackage"
          fi
